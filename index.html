<!doctype html>
<html lang="hu">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Suno Generate</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  </head>

  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div id="root" class="min-h-screen"></div>
    <noscript>Engedélyezd a JavaScriptet.</noscript>

    <script>
      const e = React.createElement;

      // ------------------ KATALÓGUSOK ------------------
      const GENRES = ["pop","rock","hip-hop","r&b","electronic","jazz","blues","cinematic","ambient"];
      const MOODS = ["energetic","uplifting","happy","sad","melancholic","romantic","dark","epic"];
      const LANGUAGES = ["magyar","angol","spanyol","német","francia"];
      const INSTRUMENTS = ["acoustic guitar","electric guitar","bass guitar","piano","synths","strings","drums","choir","saxophone"];

      // ------------------ SEGÉDEK ------------------
      const LS_KEY = "suno-ui-v3";
      function clsx(...parts){ return parts.filter(Boolean).join(" "); }
      async function postJSON(url, data){
        const resp = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
        const text = await resp.text();
        try { return { ok: resp.ok, data: JSON.parse(text) }; }
        catch { return { ok: resp.ok, data: { raw: text } }; }
      }
      function copy(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }
      function bpmTag(bpm){ if(!bpm) return null; return `${bpm} BPM`; }

      // ------------------ PROMPT ÉPÍTŐK ------------------
      function buildLyricsPrompt({ topic, genre, mood, bpm, language, explicit }){
        return [
          `Feladat: írj énekelhető dalszöveget.`,
          `Nyelv: ${language}.`,
          `Műfaj: ${genre}. Hangulat: ${mood}. Tempó: ${bpmTag(bpm) ?? "közepes"}.`,
          explicit ? `Szöveg: explicit nyelvezet megengedett.` : `Szöveg: tiszta (clean), rádióbarát.`,
          `Téma/brief: ${topic || "szabad téma"}.`,
          `Formátum: 2–3 versszak és 1–2 refrén.`,
          `A szakaszcímeket mindig szögletes zárójelben add meg, pl. [Verse 1], [Chorus].`,
          `Ne írj akkordokat, csak a dalszöveget add vissza.`
        ].join("\n");
      }

      function buildSunoPrompt({ topic, genre, mood, bpm, language, instruments, vocal, keySig, explicit }){
        const tags = [
          genre, mood, bpmTag(bpm),
          instruments.length ? `instruments: ${instruments.join(", ")}` : null,
          vocal ? `vocal: ${vocal}` : null,
          keySig ? `key: ${keySig}` : null,
          `language: ${language}`,
          explicit ? "explicit" : "clean",
          "studio mix, high quality"
        ].filter(Boolean).join(", ");

        const description = topic || "catchy original track";
        return `${description} — ${tags}`;
      }

      // ------------------ TOAST ------------------
      function Toast({text, show}) {
        return e("div", {
          className: clsx(
            "fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full bg-slate-800 border border-slate-700 shadow",
            "transition-all duration-200",
            show ? "opacity-100 translate-y-0" : "opacity-0 translate-y-3 pointer-events-none"
          )
        }, text);
      }

      // ------------------ APP ------------------
      function App(){
        const saved = React.useMemo(()=>{
          try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch { return {}; }
        },[]);

        const [topic, setTopic] = React.useState(saved.topic ?? "");
        const [genre, setGenre] = React.useState(saved.genre ?? "pop");
        const [mood, setMood] = React.useState(saved.mood ?? "uplifting");
        const [bpm, setBpm] = React.useState(saved.bpm ?? 100);
        const [language, setLanguage] = React.useState(saved.language ?? "magyar");
        const [vocal, setVocal] = React.useState(saved.vocal ?? "female lead, airy, modern pop");
        const [keySig, setKeySig] = React.useState(saved.keySig ?? "A minor");
        const [explicit, setExplicit] = React.useState(saved.explicit ?? false);
        const [selectedInstruments, setSelectedInstruments] = React.useState(saved.instruments ?? ["drums","synths"]);

        const [lyrics, setLyrics] = React.useState("");
        const [sunoPrompt, setSunoPrompt] = React.useState("");
        const [busy, setBusy] = React.useState(false);
        const [error, setError] = React.useState("");
        const [toast, setToast] = React.useState("");

        React.useEffect(()=>{
          const state = { topic, genre, mood, bpm, language, vocal, keySig, explicit, instruments: selectedInstruments };
          try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
        },[topic, genre, mood, bpm, language, vocal, keySig, explicit, selectedInstruments]);

        function showToast(t){ setToast(t); setTimeout(()=>setToast(""), 1200); }
        function toggleInstrument(name){
          setSelectedInstruments(prev => prev.includes(name) ? prev.filter(x=>x!==name) : [...prev, name]);
        }

        async function handleGenerate(){
          setError(""); setLyrics(""); setSunoPrompt("");
          setBusy(true);
          try{
            const prompt = buildLyricsPrompt({ topic, genre, mood, bpm, language, explicit });
            const res = await postJSON("/.netlify/functions/generate", { prompt, model: "gemini-1.5-flash-latest" });
            if(!res.ok) throw new Error(res?.data?.error || "Ismeretlen hiba");
            const text = res?.data?.text || res?.data?.raw || "";
            setLyrics(text);

            const suno = buildSunoPrompt({
              topic, genre, mood, bpm, language,
              instruments: selectedInstruments, vocal, keySig, explicit
            });
            setSunoPrompt(suno);
          }catch(err){ setError(String(err.message || err)); }
          finally{ setBusy(false); }
        }

        return e(React.Fragment, null,
          e("main", { className: "mx-auto max-w-5xl p-6 space-y-8" },
            e("header", { className: "space-y-1" },
              e("h1", { className: "text-2xl font-semibold" }, "Suno Generate"),
              e("p", { className: "opacity-80" },"Gyors Suno-prompt és dalszöveg összerakó Netlify Function (Gemini) backenddel.")
            ),

            error && e("div", { className:"p-3 rounded-xl bg-red-900/30 border border-red-800" }, error),

            e("section", { className: "grid md:grid-cols-2 gap-6" },
              e("div", { className: "space-y-4" },
                e("label", { className: "block text-sm opacity-80" }, "Téma / brief"),
                e("textarea", {
                  className: "w-full h-28 bg-slate-900/70 border border-slate-800 rounded-xl p-3 outline-none focus:ring-2 focus:ring-indigo-500",
                  placeholder: "pl. nyári éjszakák, városi fények, szabadság érzése…",
                  value: topic, onChange: e=>setTopic(e.target.value)
                }),
                e("div", { className: "grid grid-cols-2 gap-4" },
                  e("div", null,
                    e("label", { className: "block text-sm opacity-80 mb-1" }, "Műfaj"),
                    e("select", {
                      className: "w-full bg-slate-900/70 border border-slate-800 rounded-xl p-2",
                      value: genre, onChange: e=>setGenre(e.target.value)
                    }, GENRES.map(g=>e("option",{key:g, value:g}, g)))
                  ),
                  e("div", null,
                    e("label", { className: "block text-sm opacity-80 mb-1" }, "Hangulat"),
                    e("select", {
                      className: "w-full bg-slate-900/70 border border-slate-800 rounded-xl p-2",
                      value: mood, onChange: e=>setMood(e.target.value)
                    }, MOODS.map(g=>e("option",{key:g, value:g}, g)))
                  ),
                ),
                e("div", { className: "grid grid-cols-2 gap-4" },
                  e("div", null,
                    e("label", { className: "block text-sm opacity-80 mb-1" }, `Tempó: ${bpm} BPM`),
                    e("input", {
                      type:"range", min:60, max:160, step:1,
                      className: "w-full",
                      value: bpm, onChange: e=>setBpm(Number(e.target.value))
                    })
                  ),
                  e("div", null,
                    e("label", { className: "block text-sm opacity-80 mb-1" }, "Nyelv"),
                    e("select", {
                      className: "w-full bg-slate-900/70 border border-slate-800 rounded-xl p-2",
                      value: language, onChange: e=>setLanguage(e.target.value)
                    }, LANGUAGES.map(l=>e("option",{key:l, value:l}, l)))
                  )
                ),
                e("label", { className: "inline-flex items-center gap-2 text-sm opacity-90" },
                  e("input",{type:"checkbox", checked: explicit, onChange: e=>setExplicit(e.target.checked)}),
                  "Explicit szöveg engedélyezett"
                )
              ),

              e("div", { className: "space-y-4" },
                e("label", { className: "block text-sm opacity-80" }, "Hangszerek (több is választható)"),
                e("div", { className: "grid grid-cols-2 md:grid-cols-3 gap-2" },
                  INSTRUMENTS.map(name =>
                    e("label", {
                      key: name,
                      className: clsx(
                        "flex items-center gap-2 rounded-lg px-3 py-2 border cursor-pointer select-none",
                        selectedInstruments.includes(name) ? "border-indigo-500 bg-indigo-500/10" : "border-slate-800 bg-slate-900/50"
                      )
                    },
                      e("input",{type:"checkbox", checked:selectedInstruments.includes(name), onChange: ()=>toggleInstrument(name)}),
                      e("span", null, name)
                    )
                  )
                ),
                e("div", { className: "grid grid-cols-2 gap-4" },
                  e("div", null,
                    e("label", { className: "block text-sm opacity-80 mb-1" }, "Énekstílus"),
                    e("input", {
                      className: "w-full bg-slate-900/70 border border-slate-800 rounded-xl p-2",
                      value: vocal, onChange: e=>setVocal(e.target.value)
                    })
                  ),
                  e("div", null,
                    e("label", { className: "block text-sm opacity-80 mb-1" }, "Hangnem"),
                    e("input", {
                      className: "w-full bg-slate-900/70 border border-slate-800 rounded-xl p-2",
                      value: keySig, onChange: e=>setKeySig(e.target.value)
                    })
                  )
                )
              )
            ),

            e("div", { className: "flex items-center gap-3" },
              e("button", {
                className: clsx(
                  "px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500",
                  busy && "opacity-60 pointer-events-none"
                ),
                onClick: handleGenerate
              }, busy ? "Generálás…" : "Dalszöveg + Suno prompt generálása"),
              e("button", {
                className: "px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700",
                onClick: ()=>{
                  setTopic(""); setLyrics(""); setSunoPrompt("");
                }
              }, "Törlés")
            ),

            e("section", { className: "grid md:grid-cols-2 gap-6" },
              e("div", { className: "space-y-3" },
                e("div", { className: "flex items-center justify-between" },
                  e("h2", { className: "text-lg font-semibold" }, "Dalszöveg"),
                  e("button", {
                    className: "text-sm opacity-80 hover:opacity-100 underline",
                    onClick: ()=>{ copy(lyrics); showToast("Dalszöveg másolva"); },
                    disabled: !lyrics
                  },"Másolás")
                ),
                e("textarea", {
                  className: "w-full min-h-[14rem] bg-slate-900/60 p-4 rounded-xl border border-slate-800 resize-y",
                  value: lyrics,
                  onChange: ev => setLyrics(ev.target.value),
                  placeholder: "Itt jelenik meg és szerkeszthető a generált dalszöveg."
                })
              ),
              e("div", { className: "space-y-3" },
                e("div", { className: "flex items-center justify-between" },
                  e("h2", { className: "text-lg font-semibold" }, "Suno prompt"),
                  e("button", {
                    className: "text-sm opacity-80 hover:opacity-100 underline",
                    onClick: ()=>{ copy(sunoPrompt); showToast("Suno prompt másolva"); },
                    disabled: !sunoPrompt
                  },"Másolás")
                ),
                e("textarea", {
                  className: "w-full min-h-[14rem] bg-slate-900/60 p-4 rounded-xl border border-slate-800 resize-y",
                  value: sunoPrompt,
                  onChange: ev => setSunoPrompt(ev.target.value),
                  placeholder: "Itt jelenik meg és szerkeszthető az összeállított Suno prompt."
                })
              )
            )
          ),
          e(Toast, { text: toast, show: !!toast })
        );
      }

      const root = document.getElementById("root");
      ReactDOM.render(e(App), root);
      window.__APP_UNMOUNT__ = () => ReactDOM.unmountComponentAtNode(root);
    </script>
  </body>
</html>
