<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suno Prompt Gener√°tor V4 ‚Äî Gemini API</title>
  <style>
    :root{--bg:#0b0f15;--panel:#121826;--muted:#8892a6;--text:#e6edf6;--acc:#66d9e8;--line:#1f2937;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:linear-gradient(180deg,#0b0f15,#0e141f);color:var(--text)}
    .wrap{max-width:1400px;margin:20px auto;padding:12px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted)}
    .small{font-size:11px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;grid-auto-flow:row dense}
    .card{grid-column:span 12;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}

    .card.style-card { background-color: rgba(249, 115, 22, 0.1); border-color: #f97316; }
    .card.format-card { background-color: rgba(34, 197, 94, 0.1); border-color: #22c55e; }
    .card.mix-card { background-color: rgba(245, 158, 11, 0.1); border-color: #f59e0b; }


    @media(min-width:940px){.span3{grid-column:span 3}.span4{grid-column:span 4}.span5{grid-column:span 5}.span6{grid-column:span 6}.span7{grid-column:span 7}.span8{grid-column:span 8}.span9{grid-column:span 9}.span12{grid-column:span 12}}
    @media(min-width:1200px){.span7{grid-column:span 6}.span5{grid-column:span 6}.span8{grid-column:span 8}.span4{grid-column:span 4}}

    .card h2{font-size:13px;margin:0 0 8px;color:#c7d2fe;font-weight:600;letter-spacing:.2px}
    .card-number { color: var(--bad); margin-right: 8px; font-weight: 600; }
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0 4px}

    select,input[type="text"],input[type="number"],input[type="password"],textarea{width:100%;background:#0c1220;color:var(--text);border:1px solid #1f2a3a;border-radius:8px;padding:8px 10px;outline:none;font-size:12px}
    textarea{min-height:80px;resize:vertical}

    .row{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#0c1220;border:1px solid #1f2a3a;color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:11px;cursor:pointer;user-select:none}
    .chip.active{border-color:var(--acc);box-shadow:0 0 0 2px #0b1720 inset;color:#e6fff9}

    .btn{background:linear-gradient(180deg,#1f9eaa,#0f7f8a);border:none;color:#fff;padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer;font-size:12px}
    .btn.secondary{background:#0c1220;border:1px solid #1f2a3a;color:#d1d5db}
    .btn.ghost{background:transparent;border:1px dashed #2a364a;color:#cbd5e1}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .input-with-btn {display: flex; gap: 8px; align-items: center;}
    .input-with-btn input, .input-with-btn select {flex-grow: 1;}
    .input-with-btn .btn {flex-shrink: 0; padding: 8px;}

    .output{white-space:pre-wrap;background:#0c1220;border:1px dashed #1f2a3a;border-radius:12px;padding:12px;min-height:140px}

    details.fold{border:1px solid var(--line);border-radius:10px;background:#0c1220}
    details.fold summary{list-style:none;padding:8px 10px;cursor:pointer;color:#c7d2fe;font-weight:600;user-select:none;display:flex;align-items:center}
    details.fold summary::-webkit-details-marker{display:none}
    details.fold[open] summary:after{content:'‚ñ∏';margin-left:auto;opacity:.6}
    details.fold[open] summary:after{content:'‚ñæ'}

    .inst-groups{display:grid;gap:10px}
    details.inst-group{border:1px solid var(--line);border-radius:10px;background:#0c1220}
    summary.inst-head{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid #0f172a;color:#a5b4fc;font-weight:600}
    .inst-body{padding:8px}
    .inst-badge{font-size:10px;padding:2px 8px;border-radius:999px;background:#0b1324;color:#9ca3af;border:1px solid #1f2a3a;margin-left:auto}

    .meter{display:flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .badge{font-size:11px;padding:2px 8px;border:1px solid #2a364a;border-radius:999px;color:#cbd5e1}

    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0b1120;border:1px solid #1f2a3a;border-radius:6px;padding:0 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üéõÔ∏è Suno Prompt Gener√°tor V4 <span class="muted small">(HU fel√ºlet ‚Ä¢ EN prompt, Gemini API)</span></h1>
      <div class="toolbar">
        <button class="btn secondary" id="savePresetBtn" title="Be√°ll√≠t√°sok ment√©se a b√∂ng√©sz≈ëbe">Ment√©s</button>
        <button class="btn secondary" id="loadPresetBtn" title="Kor√°bbi ment√©s bet√∂lt√©se">Bet√∂lt√©s</button>
        <button class="btn secondary" id="exportBtn">Export</button>
        <button class="btn secondary" id="importBtn">Import</button>
        <button class="btn ghost" id="resetBtn">Vissza√°ll√≠t√°s</button>
      </div>
    </header>

    <div class="grid">
      <section class="card span6">
        <h2><span class="card-number">1.</span>Alapok</h2>
        <label for="title">Munkac√≠m (nem k√∂telez≈ë)</label>
        <div class="input-with-btn">
          <input id="title" type="text" placeholder="Pl. Midnight Swing" />
          <button class="btn secondary" id="generateTitleBtn" title="C√≠m gener√°l√°sa a t√©ma alapj√°n">‚ú®</button>
        </div>

        <div class="two" style="margin-top:6px">
          <div>
            <label for="tempoMode">Tempo m√≥d</label>
            <select id="tempoModeSelect">
              <option value="bpm" selected>BPM megad√°sa</option>
              <option value="original">Original</option>
            </select>
            <div class="small muted" style="margin-top:4px">
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" id="tempoOriginalTag" /> <span>Jel√∂lje a promptban: <span class="kbd">Tempo: original BPM</span></span>
              </label>
            </div>
          </div>
          <div>
            <label for="tempo">Tempo (BPM)</label>
            <input id="tempo" type="number" min="40" max="220" step="1" value="100" />
          </div>
        </div>

        <div class="two" style="margin-top:6px">
          <div>
            <label for="key">Hangnem</label>
            <select id="key">
              <option value="">No specific key</option>
              <option>C major</option><option>G major</option><option>D major</option><option>A major</option><option>E major</option><option>B major</option><option>F# major</option><option>F major</option>
              <option>A minor</option><option>E minor</option><option>B minor</option><option>F# minor</option><option>C# minor</option><option>G# minor</option><option>D minor</option>
            </select>
          </div>
          <div>
            <label for="timeSignature">√útemmutat√≥</label>
            <div class="input-with-btn">
                <select id="timeSignature">
                  <option value="">Nincs megadva</option>
                  <option>2/4</option>
                  <option>3/4</option>
                  <option selected>4/4</option>
                  <option>5/4</option>
                  <option>6/8</option>
                  <option>7/8</option>
                  <option>12/8</option>
                </select>
                <button class="btn secondary" id="suggestTimeSignatureBtn" title="√útemmutat√≥ javasl√°sa">‚ú®</button>
            </div>
          </div>
        </div>

        <label>Vok√°l</label>
        <div class="row" id="vocalChips">
          <div class="chip" data-value="instrumental">Instrumental only</div>
          <div class="chip active" data-value="vocal">Include vocal</div>
          <div class="chip" data-value="choir">Choir / backing only</div>
        </div>

        <div id="vocalExtras" style="display:none; margin-top:6px"></div>
        <div id="lyricsGenOpts" style="display:none; margin-top:6px">
          <label for="lyricsLang">Sz√∂veg nyelve</label>
          <select id="lyricsLang">
            <option value="en">English</option>
            <option value="hu">Magyar</option>
            <option value="it">Italiano</option>
          </select>
          <button class="btn" id="regenLyricsBtn">Dalsz√∂veg (√∫jra)gener√°l√°sa ‚ú®</button>
        </div>
        <label for="lyricsText" id="lyricsTextLabel" style="margin-top:6px">Dalsz√∂veg (beilleszthet≈ë)</label>
        <div class="toolbar" style="margin-bottom: 4px;">
            <button class="btn secondary" id="rhymeAssistBtn">R√≠m Javaslat ‚ú®</button>
            <button class="btn secondary" id="metaphorAssistBtn">Metafora Javaslat ‚ú®</button>
            <button class="btn secondary" id="verseExpanderBtn">Verze B≈ëv√≠t√©se ‚ú®</button>
        </div>
        <div id="lyricsSuggestionOutput" class="output" style="min-height: 40px; font-size: 11px; display: none; margin-bottom: 4px;"></div>
        <textarea id="lyricsText" placeholder="[verse] ... [chorus] ..."></textarea>

        <label style="margin-top:6px">Vok√°l t√≠pus</label>
        <div class="row" id="vocalType">
          <div class="chip" data-voctype="male">F√©rfi</div>
          <div class="chip" data-voctype="female">N≈ëi</div>
          <div class="chip" data-voctype="child">Gyerek</div>
          <div class="chip" data-voctype="female choir">N≈ëi k√≥rus</div>
          <div class="chip" data-voctype="male choir">F√©rfi k√≥rus</div>
          <div class="chip" data-voctype="mixed choir">Mix k√≥rus</div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
            <label for="mood" style="margin: 0;">Hangulat (szavak vessz≈ëvel)</label>
            <button class="btn secondary" id="suggestMoodThemeBtn" title="Hangulat & T√©ma javaslat k√©r√©se">Hangulat & T√©ma Javaslat ‚ú®</button>
        </div>
        <input id="mood" type="text" placeholder="romantic, cinematic, dramatic, warm" value="cinematic, dynamic, warm" />
        
        <label for="theme" style="margin-top:6px">T√©ma / r√∂vid le√≠r√°s (HU vagy EN)</label>
        <textarea id="theme" placeholder="Pl. A lively vintage feel with modern punch."></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn secondary" id="forceHuDetect">HU ‚Üí EN ford√≠t√°s a t√©m√°ra ‚ú®</button>
          <button class="btn secondary" id="copyThemeBtn">T√©ma m√°sol√°sa</button>
        </div>
      </section>

      <section class="card span6 format-card" id="formatCard">
        <h2><span class="card-number">2.</span>Form√°tum & st√≠lus (Suno kompatibilit√°s)</h2>
        <div class="small muted" style="margin-top:4px; margin-bottom: 8px;">
          Az oldal most m√°r biztons√°gosan, Netlify funkci√≥kon kereszt√ºl haszn√°lja a Gemini API-t.
          Kulcsot a <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--acc);">Google AI Studio</a>-ban szerezhetsz, √©s a Netlify oldalon kell t√°rolnod.
        </div>
        
        <div class="two">
          <div>
            <label for="promptMode">Prompt st√≠lus</label>
            <select id="promptMode">
              <option value="compact" selected>Kompakt (kulcsszavas)</option>
              <option value="verbose">R√©szletes (mondatos)</option>
            </select>
          </div>
        </div>
        
        <label for="styleExtra" style="margin-top:6px">Extra st√≠lus-megjegyz√©s</label>
        <input id="styleExtra" type="text" placeholder="Pl. 1930s radio texture, sidechain pump" />

        <label for="negative" style="margin-top:6px">Negat√≠v / ker√ºlend≈ë elemek</label>
        <div class="input-with-btn">
            <input id="negative" type="text" placeholder="no distortion, no harsh sibilance, avoid EDM drops" />
            <button class="btn secondary" id="suggestNegativeBtn" title="Negat√≠v elemek javasl√°sa">‚ú®</button>
        </div>

        <!-- Lenyithat√≥ men√º a gyors sablonokhoz -->
        <label for="quickPresetsDropdown" style="margin-top:6px">Gyors sablonok</label>
        <select id="quickPresetsDropdown">
          <option value="">V√°lassz egy sablont‚Ä¶</option>
        </select>
      </section>

      <section class="card span8 style-card">
        <h2><span class="card-number">3.</span>Zenei st√≠lus</h2>
        <label>V√°laszd ki (t√∂bb is lehet)</label>
        <div class="row" id="styleChips"></div>
        <button class="btn secondary" id="styleBlenderBtn" style="margin-top: 8px;">St√≠lus Kever≈ë ‚ú®</button>
      </section>

      <section class="card span4">
        <h2><span class="card-number">4.</span>Hangszerel√©s</h2>
        <div id="instChips" class="inst-groups"></div>
        <button class="btn secondary" id="suggestInstBtn" style="margin-top:6px">Hangszerek javasl√°sa ‚ú®</button>
        <label for="instExtra" style="margin-top:6px">Extra hangszerel√©s</label>
        <input id="instExtra" type="text" placeholder="Pl. muted trumpets, pizzicato cellos, brushed snare" />
      </section>

      <section class="card span8 mix-card">
        <h2><span class="card-number">5.</span>Szerkezet & Mix</h2>
        <label for="dynamicsDescription">Dinamika le√≠r√°sa</label>
        <div class="input-with-btn">
            <input id="dynamicsDescription" type="text" placeholder="Pl. lassan indul, a k√∂zep√©n felp√∂r√∂g..." />
            <button class="btn secondary" id="suggestStructureBtn" title="Szerkezet javasl√°sa a dinamika alapj√°n">‚ú®</button>
        </div>
        <label for="structurePreset" style="margin-top:6px">Szerkezet (preset)</label>
        <select id="structurePreset">
          <option value="">Custom / None</option>
          <option>Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Bridge ‚Äì Chorus ‚Äì Outro</option>
          <option>Intro ‚Äì A ‚Äì A ‚Äì B ‚Äì A ‚Äì Outro</option>
          <option>Intro ‚Äì Build ‚Äì Drop ‚Äì Break ‚Äì Drop ‚Äì Outro</option>
          <option>Overture ‚Äì Theme ‚Äì Development ‚Äì Recap ‚Äì Coda</option>
        </select>
        <label for="structure" style="margin-top:6px">Saj√°t szerkezet (fel√ºl√≠rja a presetet)</label>
        <textarea id="structure" placeholder="√çrd le vagy hagyd √ºresen a presethez."></textarea>

        <div class="two" style="margin-top:6px">
          <div>
            <label for="ending">Z√°r√°s (Ending)</label>
            <select id="ending">
              <option>clear, resolved ending (no fade-out)</option>
              <option>cold stop (sudden end)</option>
              <option>long reverb tail</option>
              <option>gradual fade-out</option>
            </select>
          </div>
          <div>
            <label for="mix">Mix / Produkci√≥</label>
            <div class="input-with-btn">
                <input id="mix" type="text" placeholder="Tight low end, wide strings, gentle saturation, no clipping." />
                <button class="btn secondary" id="suggestMixBtn" title="Mix/produkci√≥s javaslat k√©r√©se">‚ú®</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card span12">
        <h2><span class="card-number">6.</span>Prompt kimenet</h2>
        <div class="toolbar" style="margin-bottom:6px">
          <button class="btn" id="generateBtn">Prompt k√©sz√≠t√©se</button>
          <button class="btn secondary" id="copyBtn">M√°sol√°s</button>
          <button class="btn secondary" id="optimizePromptBtn">Optimaliz√°l√°s ‚ú®</button>
          <button class="btn secondary" id="shortenBtn">R√∂vid√≠t√©s ‚ú®</button>
          <button class="btn secondary" id="expandBtn">B≈ëv√≠t√©s ‚ú®</button>
          <span class="badge" id="lengthBadge">0 ch</span>
          <span class="meter"><span class="dot" id="lenDot"></span><span class="small muted" id="lenHint">Ide√°lis</span></span>
        </div>
        <textarea id="output" class="output"></textarea>
        <div class="small muted" style="margin-top:6px">A Prompt mez≈ë csak a zenei le√≠r√°st tartalmazza. A dalsz√∂veg al√°bb tal√°lhat√≥.</div>
      </section>
      
      <section class="card span12" id="lyricsOutputSection" style="display:none;">
        <h2><span class="card-number">7.</span>Dalsz√∂veg kimenet</h2>
        <div class="toolbar" style="margin-bottom:6px">
          <button class="btn" id="copyLyricsBtn">Sz√∂veg m√°sol√°sa</button>
        </div>
        <textarea id="lyricsOutput" class="output" readonly></textarea>
        <div class="small muted" style="margin-top:6px">A dalsz√∂veg a Suno AI √°ltal elv√°rt form√°tumban.</div>
      </section>

    </div>
  </div>

  <script>
    // ‚Äî‚Äî‚Äî Adatk√©szletek ‚Äî‚Äî‚Äî
    const STYLE_PRESETS = [
      "electro swing","blues","slowfox","samba","mambo","cha-cha-cha","bossa nova","tango","waltz",
      "soul","rap","EDM","pop","pop rock","rock ballad","indie","metal","rock & roll","reggae",
      "electro-classic","techno","rave","techno dance","disco","R&B","electronic dance","gospel","classical",
      "folk","ska","jazz","hip-hop","ambient","trance","house","trap","synth-pop","synthwave",
      "cinematic orchestral","baroque","renaissance","opera","swing","big band","big band swing","romantic piano",
      "baroque pop","romantic classical","latin","latin pop","salsa","flamenco","chillwave","electro",
      "lofi hip hop","jazz ballad","folk acoustic","drum and bass","indie rock",
      "grand orchestral (nagyzenekari)"
    ];

    const STYLE_TIME_SIGNATURES = {
      'waltz': '3/4',
      'samba': '2/4',
      'tango': '4/4',
      'slowfox': '4/4',
      'cha-cha-cha': '4/4',
      'mambo': '4/4',
      'reggae': '4/4',
      'ska': '4/4',
      'jig': '6/8'
    };

    // ‚Äî‚Äî‚Äî Hangszer csoportok ‚Äî‚Äî‚Äî
    const INSTRUMENT_GROUPS = [
      { name: 'Von√≥sok', items: [
        'string ensemble','violin section','viola section','cello section','double basses','solo violin','solo cello','harp'
      ]},
      { name: 'Faf√∫v√≥sok', items: [
        'flute','oboe','clarinet','bassoon','piccolo','alto saxophone','tenor saxophone','woodstring ensemble'
      ]},
      { name: 'R√©zf√∫v√≥sok', items: [
        'trumpet section','horns in F','trombone section','tuba','brass ensemble'
      ]},
      { name: 'Billenty≈±s√∂k', items: [
        'piano','electric piano','harpsichord','organ','synthesizer','synth pads','analog arpeggios'
      ]},
      { name: '√út≈ës√∂k / Dob', items: [
        'timpani','snare drum (orchestral)','cymbals','modern drum kit','electronic drums','shaker','congas','bongas'
      ]},
      { name: 'Pop / Band', items: [
        'electric guitar','acoustic guitar','bass guitar','upright bass','saxophone (alto)','saxophone (tenor)','trumpet section','trombone section','modern drum kit'
      ]},
      { name: 'K√≥rus / Vok√°l', items: [
        'choir (oohs)','female choir','male choir','mixed choir','solo vocal (female)','solo vocal (male)'
      ]}
    ];

    // --- √ñsszes el√©rhet≈ë hangszer list√°ja az API-nak ---
    const ALL_AVAILABLE_INSTRUMENTS = INSTRUMENT_GROUPS.flatMap(group => group.items);

    // ‚Äî‚Äî‚Äî Gyors sablonok (lenyithat√≥) ‚Äî‚Äî‚Äî
    const QUICK_PRESETS = [
      {name:'Cinematic Ballad', set:{style:['cinematic orchestral','romantic piano','jazz ballad'], inst:['string ensemble','solo cello','piano','horns in F','timpani','modern drum kit'], tempo:72, mood:'emotional, warm, expansive', key:'A minor', mix:'wide strings, gentle tape sat, clear vocal', structure:'Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Bridge ‚Äì Chorus ‚Äì Outro', negative:'no heavy distortion, no EDM drop'}},
      {name:'EDM Drop', set:{style:['EDM','trance','house'], inst:['synthesizer','synth pads','sub bass','modern drum kit'], tempo:128, mood:'energetic, euphoric, bright', key:'E minor', mix:'sidechain pump, tight low end', structure:'Intro ‚Äì Build ‚Äì Drop ‚Äì Break ‚Äì Drop ‚Äì Outro', negative:'no guitars, no orchestral strings'}},
      {name:'Retro Swing', set:{style:['swing','big band','electro swing'], inst:['trumpet section','trombone section','saxophone (alto)','saxophone (tenor)','drum kit (brushes)','upright bass'], tempo:110, mood:'playful, vintage, lively', key:'C major', mix:'tape vibe, crisp brass', structure:'Intro ‚Äì A ‚Äì A ‚Äì B ‚Äì A ‚Äì Outro', negative:'no modern EDM synths'}},
      {name:'Epic Orchestral', set:{style:['epic orchestral','cinematic orchestral'], inst:['string ensemble','brass ensemble','timpani','snare drum (orchestral)','choir (oohs)'], tempo:90, mood:'majestic, powerful, dramatic', key:'D minor', mix:'wide dynamic range, reverb on brass', structure:'Overture ‚Äì Theme ‚Äì Development ‚Äì Recap ‚Äì Coda', negative:'no electronic synths'}},
      {name:'Lo-fi Chillhop', set:{style:['lofi hip hop','chillhop'], inst:['electric piano','synth pads','upright bass','modern drum kit'], tempo:80, mood:'relaxed, nostalgic, warm', key:'F major', mix:'vinyl crackle, soft compression', structure:'Intro ‚Äì Loop A ‚Äì Loop B ‚Äì Outro', negative:'no aggressive drums'}},
      {name:'Latin Fiesta', set:{style:['latin','salsa','flamenco'], inst:['acoustic guitar','congas','bongas','trumpet section','trombone section'], tempo:110, mood:'festive, energetic, colorful', key:'G major', mix:'bright percussion, live feel', structure:'Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Outro', negative:'no electronic beats'}},
      {name:'Ambient Soundscape', set:{style:['ambient','soundscape'], inst:['synth pads','flute','string ensemble','harp'], tempo:60, mood:'calm, ethereal, spacious', key:'E minor', mix:'long reverb tails, slow attack', structure:'Freeform', negative:'no drums'}},
      {name:'Rock Anthem', set:{style:['rock','pop rock'], inst:['electric guitar','bass guitar','modern drum kit','synth pads'], tempo:120, mood:'energetic, bold, uplifting', key:'A major', mix:'punchy drums, tight guitars', structure:'Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Bridge ‚Äì Chorus ‚Äì Outro', negative:'no orchestral strings'}},
      {name:'Jazz Ballad', set:{style:['jazz ballad'], inst:['piano','upright bass','drum kit (brushes)','saxophone (tenor)'], tempo:70, mood:'smooth, romantic, intimate', key:'Bb major', mix:'warm tone, close-mic feel', structure:'Intro ‚Äì A ‚Äì B ‚Äì A ‚Äì Outro', negative:'no electronic synths'}},
      {name:'Synthwave Dream', set:{style:['synthwave','retro'], inst:['synthesizer','analog arpeggios','sub bass','electronic drums'], tempo:100, mood:'nostalgic, dreamy, atmospheric', key:'C minor', mix:'lush pads, gated reverb', structure:'Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Outro', negative:'no acoustic instruments'}},
      {name:'Baroque Pop', set:{style:['baroque pop'], inst:['string ensemble','harpsichord','flute','acoustic guitar'], tempo:95, mood:'ornate, lush, melodic', key:'E major', mix:'balanced mix, chamber feel', structure:'Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Outro', negative:'no heavy drums'}},
      {name:'Folk Acoustic', set:{style:['folk acoustic'], inst:['acoustic guitar','fiddle','upright bass','mandolin'], tempo:88, mood:'warm, organic, heartfelt', key:'G major', mix:'natural reverb, close-mic strings', structure:'Intro ‚Äì Verse ‚Äì Chorus ‚Äì Verse ‚Äì Chorus ‚Äì Outro', negative:'no synths'}},
      {name:'Grand Orchestral', set:{style:['grand orchestral','cinematic orchestral'], inst:['string ensemble','brass ensemble','woodwinds ensemble','timpani','choir (oohs)'], tempo:85, mood:'grand, emotional, expansive', key:'C minor', mix:'wide stereo image, hall reverb', structure:'Overture ‚Äì Theme ‚Äì Development ‚Äì Recap ‚Äì Coda', negative:'no electronic elements'}},
      {name:'Trap 150 BPM', set:{style:['trap'], inst:['808 bass','hi-hat','snare','synth lead','modern drum kit'], tempo:150, mood:'dark, aggressive, confident', key:'C minor', mix:'heavy sub bass, crisp hats, stereo wideners', structure:'Intro ‚Äì Verse ‚Äì Hook ‚Äì Verse ‚Äì Hook ‚Äì Outro', negative:'no orchestral strings'}},
      {name:'Orchestral w/ Choir 80 BPM', set:{style:['cinematic orchestral'], inst:['string ensemble','brass ensemble','woodwinds','choir'], tempo:80, mood:'epic, solemn, moving', key:'C minor', mix:'wide dynamic range, resonant space', structure:'Intro ‚Äì Theme ‚Äì Bridge ‚Äì Theme ‚Äì Outro', negative:'no synth'}}
    ];

    // ‚Äî‚Äî‚Äî √Åltal√°nos seg√©d JavaScript funkci√≥k ‚Äî‚Äî‚Äî
    // A HTML elemek inicializ√°l√°sa
    document.addEventListener('DOMContentLoaded', () => {
      const styleChipsContainer = document.getElementById('styleChips');
      const instChipsContainer = document.getElementById('instChips');
      const quickPresetsDropdown = document.getElementById('quickPresetsDropdown');
      const lyricsTextarea = document.getElementById('lyricsText');
      const vocalChips = document.getElementById('vocalChips');
      const generateBtn = document.getElementById('generateBtn');
      const outputDiv = document.getElementById('output');
      const copyBtn = document.getElementById('copyBtn');
      const moodInput = document.getElementById('mood');
      const themeTextarea = document.getElementById('theme');
      const instExtraInput = document.getElementById('instExtra');
      const styleExtraInput = document.getElementById('styleExtra');
      const negativeInput = document.getElementById('negative');
      const tempoInput = document.getElementById('tempo');
      const keySelect = document.getElementById('key');
      const vocalTypeChips = document.getElementById('vocalType');
      const structureTextarea = document.getElementById('structure');
      const endingSelect = document.getElementById('ending');
      const mixInput = document.getElementById('mix');
      const shortenBtn = document.getElementById('shortenBtn');
      const expandBtn = document.getElementById('expandBtn');
      const lengthBadge = document.getElementById('lengthBadge');
      const lenDot = document.getElementById('lenDot');
      const lenHint = document.getElementById('lenHint');
      const forceHuDetectBtn = document.getElementById('forceHuDetect');
      const regenLyricsBtn = document.getElementById('regenLyricsBtn');
      const lyricsLangSelect = document.getElementById('lyricsLang');
      const lyricsGenOpts = document.getElementById('lyricsGenOpts');
      const savePresetBtn = document.getElementById('savePresetBtn');
      const loadPresetBtn = document.getElementById('loadPresetBtn');
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const resetBtn = document.getElementById('resetBtn');
      const lyricsOutputSection = document.getElementById('lyricsOutputSection');
      const lyricsOutput = document.getElementById('lyricsOutput');
      const copyLyricsBtn = document.getElementById('copyLyricsBtn');
      const suggestMoodThemeBtn = document.getElementById('suggestMoodThemeBtn');
      const generateTitleBtn = document.getElementById('generateTitleBtn');
      const suggestInstBtn = document.getElementById('suggestInstBtn');
      const titleInput = document.getElementById('title');
      const suggestMixBtn = document.getElementById('suggestMixBtn');
      const suggestNegativeBtn = document.getElementById('suggestNegativeBtn');
      const timeSignatureSelect = document.getElementById('timeSignature');
      const suggestTimeSignatureBtn = document.getElementById('suggestTimeSignatureBtn');
      const styleBlenderBtn = document.getElementById('styleBlenderBtn');
      const dynamicsDescriptionInput = document.getElementById('dynamicsDescription');
      const suggestStructureBtn = document.getElementById('suggestStructureBtn');
      const rhymeAssistBtn = document.getElementById('rhymeAssistBtn');
      const metaphorAssistBtn = document.getElementById('metaphorAssistBtn');
      const verseExpanderBtn = document.getElementById('verseExpanderBtn');
      const lyricsSuggestionOutput = document.getElementById('lyricsSuggestionOutput');
      const optimizePromptBtn = document.getElementById('optimizePromptBtn');
      const copyThemeBtn = document.getElementById('copyThemeBtn');
      const tempoModeSelect = document.getElementById('tempoModeSelect');
      const tempoOriginalTagCheckbox = document.getElementById('tempoOriginalTag');
      const structurePresetSelect = document.getElementById('structurePreset');
      const promptModeSelect = document.getElementById('promptMode');
      const formatCard = document.getElementById('formatCard');


      // St√≠lus chipek felt√∂lt√©se
      STYLE_PRESETS.forEach(style => {
        const chip = document.createElement('div');
        chip.classList.add('chip');
        chip.textContent = style;
        chip.dataset.value = style;
        chip.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            updateSuggestedTimeSignature(e.target);
        });
        styleChipsContainer.appendChild(chip);
      });

      // Hangszer chipek felt√∂lt√©se csoportokba rendezve
      INSTRUMENT_GROUPS.forEach(group => {
        const details = document.createElement('details');
        details.classList.add('inst-group');
        details.open = true; // Alapb√≥l nyitva
        const summary = document.createElement('summary');
        summary.classList.add('inst-head');
        summary.textContent = group.name;
        details.appendChild(summary);

        const body = document.createElement('div');
        body.classList.add('inst-body');
        const row = document.createElement('div');
        row.classList.add('row');
        group.items.forEach(item => {
          const chip = document.createElement('div');
          chip.classList.add('chip');
          chip.textContent = item;
          chip.dataset.value = item;
          chip.addEventListener('click', () => chip.classList.toggle('active'));
          row.appendChild(chip);
        });
        body.appendChild(row);
        details.appendChild(body);
        instChipsContainer.appendChild(details);
      });

      // Gyors sablonok felt√∂lt√©se
      QUICK_PRESETS.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.name;
        option.textContent = preset.name;
        quickPresetsDropdown.appendChild(option);
      });

      // Esem√©nykezel≈ëk
      quickPresetsDropdown.addEventListener('change', (e) => {
        const presetName = e.target.value;
        const preset = QUICK_PRESETS.find(p => p.name === presetName);
        if (preset) {
          applyPreset(preset.set);
        }
      });
      
      vocalChips.addEventListener('click', (e) => {
        if (e.target.classList.contains('chip')) {
          vocalChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
          const isInstrumental = e.target.dataset.value === 'instrumental';
          lyricsTextarea.disabled = isInstrumental;
          if (isInstrumental) {
            lyricsTextarea.value = '';
          }
          if (e.target.dataset.value === 'vocal') {
            lyricsGenOpts.style.display = 'block';
          } else {
            lyricsGenOpts.style.display = 'none';
          }
          if (lyricsTextarea.value.trim() === '') {
            lyricsOutputSection.style.display = 'none';
          } else {
            lyricsOutputSection.style.display = 'block';
          }
        }
      });
      
      vocalTypeChips.addEventListener('click', (e) => {
        if (e.target.classList.contains('chip')) {
          e.target.classList.toggle('active');
        }
      });

      tempoModeSelect.addEventListener('change', () => {
        tempoInput.disabled = (tempoModeSelect.value !== 'bpm');
        if (tempoOriginalTagCheckbox) {
            tempoOriginalTagCheckbox.disabled = (tempoModeSelect.value !== 'original');
            if (tempoModeSelect.value === 'original') {
                tempoOriginalTagCheckbox.checked = true;
                tempoInput.value = '';
            }
        }
      });
      
      if (tempoOriginalTagCheckbox) {
        tempoOriginalTagCheckbox.addEventListener('change', () => {
            tempoModeSelect.value = tempoOriginalTagCheckbox.checked ? 'original' : 'bpm';
            tempoInput.disabled = tempoOriginalTagCheckbox.checked;
            if (tempoOriginalTagCheckbox.checked) {
                tempoInput.value = '';
            }
        });
      }

      structurePresetSelect.addEventListener('change', () => {
        structureTextarea.value = structurePresetSelect.value;
      });

      generateBtn.addEventListener('click', async () => {
        const prompt = await buildPrompt();
        if (prompt) {
          outputDiv.value = prompt;
          updateLengthBadge(prompt);
          
          const lyrics = lyricsTextarea.value;
          if (lyrics.trim() !== '') {
            lyricsOutputSection.style.display = 'block';
            lyricsOutput.value = buildLyricsOutput(lyrics);
          } else {
            lyricsOutputSection.style.display = 'none';
            lyricsOutput.value = '';
          }
        }
      });

      copyBtn.addEventListener('click', () => {
        outputDiv.select();
        document.execCommand('copy');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'M√°solva!';
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      });
      
      copyLyricsBtn.addEventListener('click', () => {
        lyricsOutput.select();
        document.execCommand('copy');
        const originalText = copyLyricsBtn.textContent;
        copyLyricsBtn.textContent = 'M√°solva!';
        setTimeout(() => {
          copyLyricsBtn.textContent = originalText;
        }, 2000);
      });

      copyThemeBtn.addEventListener('click', () => {
        themeTextarea.select();
        document.execCommand('copy');
        const originalText = copyThemeBtn.textContent;
        copyThemeBtn.textContent = 'M√°solva!';
        setTimeout(() => {
            copyThemeBtn.textContent = 'T√©ma m√°sol√°sa';
        }, 2000);
      });
      
      // --- GEMINI API FUNKCI√ìK ---

      async function callGeminiAPI(prompt, button) {
          const originalText = button.textContent;
          button.textContent = '...';
          button.disabled = true;

          try {
              // A Google API helyett a Netlify f√ºggv√©nyt h√≠vjuk meg
              const apiUrl = `/.netlify/functions/gemini-proxy`;

              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      prompt: prompt
                  })
              });

              if (!response.ok) {
                  throw new Error(`API request failed with status ${response.status}`);
              }

              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }

              return result.text;
          } catch (error) {
              console.error('API call failed:', error);
              let userMessage = `API hiba: ${error.message}`;
              if (error.message.includes('403')) {
                  userMessage += '\n(A 403-as hiba jogosults√°gi probl√©m√°t jelez. Ellen≈ërizd a Netlify k√∂rnyezeti v√°ltoz√≥dat.)';
              } else if (error.message.includes('Failed to fetch')) {
                  userMessage += '\n(H√°l√≥zati hiba. Ellen≈ërizd az internetkapcsolatot.)';
              } else if (error.message.includes('SAFETY')) {
                   userMessage = 'A gener√°l√°s a biztons√°gi sz≈±r≈ëk miatt le√°llt. Pr√≥b√°lj m√°s megfogalmaz√°st.';
              }
              alert(userMessage);
              return null;
          } finally {
              button.textContent = originalText;
              button.disabled = false;
          }
      }
      
      shortenBtn.addEventListener('click', async () => {
        const currentPrompt = outputDiv.value;
        if (!currentPrompt) return;
        const prompt = `Shorten this music prompt to its essential keywords. Keep the structure (e.g., 'Style: [keywords]'). Keep it concise. Prompt: "${currentPrompt}"`;
        const result = await callGeminiAPI(prompt, shortenBtn);
        if (result) {
            outputDiv.value = result;
            updateLengthBadge(result);
        }
      });
      
      expandBtn.addEventListener('click', async () => {
        const currentPrompt = outputDiv.value;
        if (!currentPrompt) return;
        const prompt = `Expand this music prompt with more creative details. Keep the structure (e.g., 'Style: [keywords]'). Prompt: "${currentPrompt}"`;
        const result = await callGeminiAPI(prompt, expandBtn);
        if (result) {
            outputDiv.value = result;
            updateLengthBadge(result);
        }
      });
      
      regenLyricsBtn.addEventListener('click', async () => {
        const lang = lyricsLangSelect.value;
        const theme = themeTextarea.value || 'a song about anything';
        let prompt;

        if (lang === 'hu') {
            prompt = `Your task is to generate song lyrics. The lyrics must be written in the Hungarian language. The topic for the song is: "${theme}". Please only return the lyrics, structured with tags like [verse] and [chorus]. Do not add any other explanations.`;
        } else {
            const langMap = { en: 'English', it: 'Italian' };
            const languageName = langMap[lang] || 'English';
            prompt = `Write song lyrics about "${theme}". The language of the lyrics must be ${languageName}. Provide only the lyrics, with sections like [verse] and [chorus]. Do not include any introductory phrases or explanations.`;
        }
        
        const result = await callGeminiAPI(prompt, regenLyricsBtn);
        if (result) {
            lyricsTextarea.value = result.replace(/^.*?: ?/s, '').trim();
            lyricsOutputSection.style.display = 'block';
            lyricsOutput.value = buildLyricsOutput(lyricsTextarea.value);
        }
      });

      forceHuDetectBtn.addEventListener('click', async () => {
        const originalText = themeTextarea.value;
        if (!originalText) return;
        const prompt = `Translate this Hungarian text to English: "${originalText}"`;
        const result = await callGeminiAPI(prompt, forceHuDetectBtn);
        if (result) {
            themeTextarea.value = result;
        }
      });

      suggestMoodThemeBtn.addEventListener('click', async () => {
        const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        let prompt = 'Suggest a creative mood and a short theme description for a song. The response should be in English and only contain the mood and theme, separated by a semicolon. Mood should be 2-4 keywords, theme should be a short sentence. Do not include any introductory phrases or explanations. ';
        if (selectedStyles.length > 0) {
          prompt += `The song style is: ${selectedStyles.join(', ')}.`;
        }
        const result = await callGeminiAPI(prompt, suggestMoodThemeBtn);
        if (result) {
            const [mood, theme] = result.split(';').map(s => s.trim());
            if (mood) moodInput.value = mood;
            if (theme) themeTextarea.value = theme;
        }
      });

      // --- √öJ GEMINI FUNKCI√ìK ---
      
      generateTitleBtn.addEventListener('click', async () => {
          const mood = moodInput.value;
          const theme = themeTextarea.value;
          const styles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value).join(', ');
          if (!mood && !theme && !styles) {
              alert('V√°lassz st√≠lust, vagy adj meg hangulatot/t√©m√°t a c√≠m gener√°l√°s√°hoz!');
              return;
          }
          const prompt = `Suggest one creative, short song title in English for a song with the following characteristics. Return only the title itself, without quotation marks or any other text. Style: ${styles}. Mood: ${mood}. Theme: ${theme}.`;
          const result = await callGeminiAPI(prompt, generateTitleBtn);
          if (result) {
              titleInput.value = result;
          }
      });

      suggestInstBtn.addEventListener('click', async () => {
          const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
          if (selectedStyles.length === 0) {
              alert('V√°lassz legal√°bb egy zenei st√≠lust a hangszerjavaslathoz!');
              return;
          }
          const prompt = `Based on the music style(s) '${selectedStyles.join(', ')}', suggest a list of 5 to 8 appropriate musical instruments. Return only a comma-separated list of instruments from the following available options: ${ALL_AVAILABLE_INSTRUMENTS.join(', ')}.`;
          const result = await callGeminiAPI(prompt, suggestInstBtn);
          if (result) {
              // Deselect all current instruments
              instChipsContainer.querySelectorAll('.chip.active').forEach(chip => chip.classList.remove('active'));
              
              // Select suggested instruments
              const suggestedInstruments = result.split(',').map(inst => inst.trim());
              suggestedInstruments.forEach(instName => {
                  const chip = instChipsContainer.querySelector(`.chip[data-value="${instName}"]`);
                  if (chip) {
                      chip.classList.add('active');
                  }
              });
          }
      });

      suggestMixBtn.addEventListener('click', async () => {
        const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        const mood = moodInput.value;
        const selectedInst = Array.from(instChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);

        if (selectedStyles.length === 0 && !mood) {
            alert('V√°lassz st√≠lust vagy adj meg hangulatot a mix javaslathoz!');
            return;
        }

        let context = `style: ${selectedStyles.join(', ')}, mood: ${mood}`;
        if (selectedInst.length > 0) {
            context += `, instruments: ${selectedInst.join(', ')}`;
        }

        const prompt = `Suggest a short, comma-separated list of 3-4 music production and mixing notes for a song with the following characteristics: ${context}. For example: 'wide stereo image, gentle tape saturation, tight low end'. Return only the list of notes.`;
        
        const result = await callGeminiAPI(prompt, suggestMixBtn);
        if (result) {
            mixInput.value = result;
        }
      });

      suggestNegativeBtn.addEventListener('click', async () => {
        const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        const mood = moodInput.value;

        if (selectedStyles.length === 0) {
            alert('V√°lassz legal√°bb egy st√≠lust a negat√≠v javaslathoz!');
            return;
        }

        const context = `style: ${selectedStyles.join(', ')}, mood: ${mood}`;

        const prompt = `For a song with the characteristics '${context}', suggest a short, comma-separated list of 2-3 musical elements to avoid (a negative prompt). For example: 'no harsh sibilance, avoid EDM drops'. Return only the list of negative elements.`;

        const result = await callGeminiAPI(prompt, suggestNegativeBtn);
        if (result) {
            negativeInput.value = result;
        }
      });

      suggestTimeSignatureBtn.addEventListener('click', async () => {
        const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        if (selectedStyles.length === 0) {
            alert('V√°lassz legal√°bb egy zenei st√≠lust az √ºtemmutat√≥ javaslathoz!');
            return;
        }
        const prompt = `For the music style(s) '${selectedStyles.join(', ')}', what is the most common time signature? Choose from 2/4, 3/4, 4/4, 5/4, 6/8, 7/8, 12/8. Return only the time signature itself, for example: '4/4'.`;
        const result = await callGeminiAPI(prompt, suggestTimeSignatureBtn);
        if (result && Array.from(timeSignatureSelect.options).some(o => o.value === result)) {
            timeSignatureSelect.value = result;
        }
      });

      styleBlenderBtn.addEventListener('click', async () => {
        const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        if (selectedStyles.length < 2) {
            alert('V√°lassz legal√°bb k√©t st√≠lust a kever√©shez!');
            return;
        }
        const prompt = `Create a new hybrid music genre by blending the following styles: ${selectedStyles.join(', ')}. Provide a creative fantasy name for the new genre, and a short, evocative theme description. Format the response as: "Genre Name; Theme Description".`;
        const result = await callGeminiAPI(prompt, styleBlenderBtn);
        if (result) {
            const [genreName, theme] = result.split(';').map(s => s.trim());
            if (genreName) {
                styleExtraInput.value = (styleExtraInput.value ? styleExtraInput.value + ', ' : '') + genreName;
            }
            if (theme) {
                themeTextarea.value = (themeTextarea.value ? themeTextarea.value + ' ' : '') + theme;
            }
        }
      });

      suggestStructureBtn.addEventListener('click', async () => {
        const dynamics = dynamicsDescriptionInput.value;
        if (!dynamics) {
            alert('√çrd le a dal k√≠v√°nt dinamik√°j√°t a szerkezet javaslathoz!');
            return;
        }
        const prompt = `Based on the following dynamic description of a song: "${dynamics}", create a standard song structure using tags like Intro, Verse, Chorus, Bridge, Outro, Build, Drop, etc. Return only the structure string.`;
        const result = await callGeminiAPI(prompt, suggestStructureBtn);
        if (result) {
            structureTextarea.value = result;
        }
      });

      rhymeAssistBtn.addEventListener('click', async () => {
        const lyrics = lyricsTextarea.value.trim();
        const lastLine = lyrics.split('\n').pop();
        if (!lastLine) {
            alert('√çrj be legal√°bb egy sort a dalsz√∂vegbe a r√≠mjavaslathoz!');
            return;
        }
        const theme = themeTextarea.value || 'a song';
        const prompt = `Suggest 3 rhyming lines for the following lyric line: "${lastLine}". The suggestions should fit the theme of "${theme}". Return only the suggestions, each on a new line.`;
        const result = await callGeminiAPI(prompt, rhymeAssistBtn);
        if (result) {
            lyricsSuggestionOutput.innerHTML = `<strong>R√≠m javaslatok:</strong><br>${result.replace(/\n/g, '<br>')}`;
            lyricsSuggestionOutput.style.display = 'block';
        }
      });

      metaphorAssistBtn.addEventListener('click', async () => {
        const theme = themeTextarea.value;
        if (!theme) {
            alert('Adj meg egy t√©m√°t a metafora javaslathoz!');
            return;
        }
        const prompt = `Suggest 3 creative metaphors or similes related to the theme "${theme}". Return only the suggestions, each on a new line.`;
        const result = await callGeminiAPI(prompt, metaphorAssistBtn);
        if (result) {
            lyricsSuggestionOutput.innerHTML = `<strong>Metafora javaslatok:</strong><br>${result.replace(/\n/g, '<br>')}`;
            lyricsSuggestionOutput.style.display = 'block';
        }
      });

      verseExpanderBtn.addEventListener('click', async () => {
        const lyrics = lyricsTextarea.value;
        const chorusMatch = lyrics.match(/\[chorus\]([\s\S]*?)(\n\[|$)/i);
        if (!chorusMatch || !chorusMatch[1].trim()) {
            alert('√çrj egy refr√©nt ([chorus]...[/chorus]) a verze b≈ëv√≠t√©s√©hez!');
            return;
        }
        const chorus = chorusMatch[1].trim();
        const theme = themeTextarea.value || 'a song';
        const prompt = `Based on the following chorus:\n\n${chorus}\n\nAnd the theme "${theme}", write a 4-line verse that could come before this chorus. Return only the verse text, without the [verse] tag.`;
        const result = await callGeminiAPI(prompt, verseExpanderBtn);
        if (result) {
            lyricsSuggestionOutput.innerHTML = `<strong>Verze javaslat:</strong><br>${result.replace(/\n/g, '<br>')}`;
            lyricsSuggestionOutput.style.display = 'block';
        }
      });

      optimizePromptBtn.addEventListener('click', async () => {
        const currentPrompt = await buildPrompt();
        if (!currentPrompt) return;
        const prompt = `You are a world-class expert in writing prompts for the Suno AI music generator. Your task is to optimize the following user-created prompt for the best possible musical result. Refine the keywords, adjust their order for better weighting, and ensure the structure is clear and effective for the AI. Do not add new ideas, only enhance the existing ones. Return only the optimized prompt. Original prompt:\n\n${currentPrompt}`;
        const result = await callGeminiAPI(prompt, optimizePromptBtn);
        if (result) {
            outputDiv.value = result;
            updateLengthBadge(result);
        }
      });
      
      // --- EGY√âB ESEM√âNYKEZEL≈êK ---
      
      resetBtn.addEventListener('click', () => {
        resetForm();
      });

      savePresetBtn.addEventListener('click', () => {
        saveCurrentSettings();
      });

      loadPresetBtn.addEventListener('click', () => {
        loadSavedSettings(true);
      });

      exportBtn.addEventListener('click', () => {
        exportSettings();
      });

      importBtn.addEventListener('click', () => {
        importSettings();
      });

      
      // ‚Äî‚Äî‚Äî F≈ë logika: Prompt √©p√≠t√©se ‚Äî‚Äî‚Äî
      async function buildPrompt(isShort = false) {
        let prompt = '';
        const title = document.getElementById('title').value;
        const tempo = tempoInput.value;
        const key = keySelect.value;
        const vocal = vocalChips.querySelector('.chip.active').dataset.value;
        const vocalTypes = Array.from(vocalTypeChips.querySelectorAll('.chip.active')).map(c => c.dataset.voctype);
        const timeSignature = timeSignatureSelect.value;
        
        let mood = moodInput.value;
        if (mood.trim()) {
            const translationPrompt = `You are an expert music assistant. A user has provided a comma-separated list of keywords describing the mood of a song. Your task is to translate these keywords to English. If the keywords are already in English, return them unchanged. Provide ONLY the comma-separated list of English keywords as your response. Keywords: "${mood}"`;
            const translatedMood = await callGeminiAPI(translationPrompt, generateBtn);
            if (translatedMood) {
                mood = translatedMood;
                moodInput.value = mood;
            } else {
                return null;
            }
        }

        const selectedStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        const selectedInst = Array.from(instChipsContainer.querySelectorAll('.chip.active')).map(c => c.dataset.value);
        const instExtra = instExtraInput.value;
        const styleExtra = styleExtraInput.value;
        const negative = negativeInput.value;
        const structure = structureTextarea.value;
        const ending = endingSelect.value;
        const mix = mixInput.value;

        // Vok√°l blokk
        if (vocal === 'instrumental') {
          prompt += 'Vocal: instrumental only\n';
        } else if (vocal === 'choir') {
          prompt += 'Vocal: choir / backing only\n';
        } else {
          // Itt m√°r csak a vok√°l t√≠pus ker√ºl bele, a dalsz√∂veg nem
          if (vocalTypes.length > 0) {
              const types = vocalTypes.map(vt => `${vt} vocal`).join(', ');
              prompt += `Vocal: ${types}\n`;
          }
        }

        // Hangulat √©s st√≠lusok
        let styleString = selectedStyles.join(', ');
        if (styleExtra) {
          if (styleString) styleString += `, ${styleExtra}`;
          else styleString += styleExtra;
        }
        if (mood) {
          if (styleString) styleString += `, ${mood}`;
          else styleString += mood;
        }
        if (styleString) {
          prompt += `Style: [${styleString}]\n`;
        }

        // Hangszerek
        let instString = selectedInst.join(', ');
        if (instExtra) {
          if (instString) instString += `, ${instExtra}`;
          else instString += instExtra;
        }
        if (instString) {
          // Az 'only' sz√≥ hozz√°ad√°sa egy hangszer eset√©n
          if (selectedInst.length === 1 && !instExtra) {
            prompt += `Instruments: [only ${instString}]\n`;
          } else {
            prompt += `Instruments: [${instString}]\n`;
          }
        }
        
        // Zene technikai adatok
        if (tempo) {
          prompt += `Tempo: ${tempo}\n`;
        }
        if (key) {
          prompt += `Key: ${key}\n`;
        }
        if (timeSignature) {
          prompt += `Time Signature: ${timeSignature}\n`;
        }
        if (structure) {
          prompt += `Structure: ${structure}\n`;
        }
        if (ending) {
          prompt += `Ending: ${ending}\n`;
        }
        if (mix) {
          prompt += `Mix: ${mix}\n`;
        }
        if (negative) {
          prompt += `Negative: ${negative}\n`;
        }
        
        // C√≠m
        if (title) {
          prompt += `Title: ${title}\n`;
        }

        return prompt.trim();
      }

      function buildLyricsOutput(lyrics) {
        const stanzas = lyrics.split(/\n\s*\n/);
        const tags = ['[Verse]', '[Chorus]', '[Verse]', '[Chorus]', '[Bridge]', '[Chorus]', '[Outro]'];
        const taggedStanzas = stanzas.map((stanza, index) => {
            const hasTag = ['[verse]', '[chorus]', '[bridge]', '[intro]', '[outro]'].some(tag => stanza.toLowerCase().trim().startsWith(tag));

            if (hasTag) {
                return stanza.trim();
            } else {
                const tag = tags[index] || '[Verse]';
                return `${tag}\n${stanza.trim()}`;
            }
        });
        
        return taggedStanzas.join('\n\n').trim();
    }


      function updateLengthBadge(prompt) {
        const length = prompt.length;
        lengthBadge.textContent = `${length} ch`;
        if (length > 250) {
          lenDot.classList.remove('good', 'warn');
          lenDot.classList.add('bad');
          lenHint.textContent = 'T√∫l hossz√∫';
        } else if (length > 150) {
          lenDot.classList.remove('good', 'bad');
          lenDot.classList.add('warn');
          lenHint.textContent = 'Kicsit hossz√∫';
        } else {
          lenDot.classList.remove('warn', 'bad');
          lenDot.classList.add('good');
          lenHint.textContent = 'Ide√°lis';
        }
      }

      function applyPreset(preset) {
        resetForm(false);
        // St√≠lusok
        if (preset.style) {
          preset.style.forEach(s => {
            const chip = styleChipsContainer.querySelector(`.chip[data-value="${s}"]`);
            if (chip) chip.classList.add('active');
          });
        }
        // Hangszerek
        if (preset.inst) {
          preset.inst.forEach(i => {
            const chip = instChipsContainer.querySelector(`.chip[data-value="${i}"]`);
            if (chip) chip.classList.add('active');
          });
        }
        // Egy√©b be√°ll√≠t√°sok
        if (preset.tempo) tempoInput.value = preset.tempo;
        if (preset.mood) moodInput.value = preset.mood;
        if (preset.key) keySelect.value = preset.key;
        if (preset.mix) mixInput.value = preset.mix;
        if (preset.structure) structureTextarea.value = preset.structure;
        if (preset.negative) negativeInput.value = preset.negative;
        updateSuggestedTimeSignature(); // Update based on preset styles
      }
      
      function resetForm() {
          document.getElementById('title').value = '';
          document.getElementById('tempo').value = '100';
          document.getElementById('key').value = '';
          document.getElementById('lyricsText').value = '';
          document.getElementById('lyricsText').disabled = false;
          document.getElementById('mood').value = 'cinematic, dynamic, warm';
          document.getElementById('theme').value = '';
          document.getElementById('styleExtra').value = '';
          document.getElementById('negative').value = '';
          document.getElementById('structure').value = '';
          document.getElementById('ending').value = 'clear, resolved ending (no fade-out)';
          document.getElementById('mix').value = '';
          document.getElementById('instExtra').value = '';
          document.getElementById('output').textContent = '';
          document.getElementById('lengthBadge').textContent = '0 ch';
          lyricsOutput.value = '';
          lyricsOutputSection.style.display = 'none';
          timeSignatureSelect.value = '4/4';
          dynamicsDescriptionInput.value = '';
          lyricsSuggestionOutput.style.display = 'none';
          
          document.querySelectorAll('.chip.active').forEach(chip => chip.classList.remove('active'));
          vocalChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          document.querySelector('#vocalChips .chip[data-value="vocal"]').classList.add('active');
          
          lyricsGenOpts.style.display = 'block';

          updateLengthBadge('');
      }

      function saveCurrentSettings() {
        const settings = {
          title: document.getElementById('title').value,
          tempo: document.getElementById('tempo').value,
          key: document.getElementById('key').value,
          lyrics: document.getElementById('lyricsText').value,
          vocal: document.querySelector('#vocalChips .chip.active').dataset.value,
          vocalTypes: Array.from(document.querySelectorAll('#vocalType .chip.active')).map(c => c.dataset.voctype),
          mood: document.getElementById('mood').value,
          theme: document.getElementById('theme').value,
          styles: Array.from(document.querySelectorAll('#styleChips .chip.active')).map(c => c.dataset.value),
          styleExtra: document.getElementById('styleExtra').value,
          negative: document.getElementById('negative').value,
          instruments: Array.from(document.querySelectorAll('#instChips .chip.active')).map(c => c.dataset.value),
          instExtra: document.getElementById('instExtra').value,
          structure: document.getElementById('structure').value,
          ending: document.getElementById('ending').value,
          mix: document.getElementById('mix').value,
          timeSignature: timeSignatureSelect.value,
        };
        localStorage.setItem('sunoPromptGeneratorSettings', JSON.stringify(settings));
        const originalText = savePresetBtn.textContent;
        savePresetBtn.textContent = 'Mentve!';
        setTimeout(() => {
          savePresetBtn.textContent = originalText;
        }, 2000);
      }

      function loadSavedSettings(showNotification = false) {
        const savedSettings = localStorage.getItem('sunoPromptGeneratorSettings');
        if (savedSettings) {
          const settings = JSON.parse(savedSettings);
          applyImportedSettings(settings);
          if (showNotification) {
            const originalText = loadPresetBtn.textContent;
            loadPresetBtn.textContent = 'Bet√∂ltve!';
            setTimeout(() => {
              loadPresetBtn.textContent = originalText;
            }, 2000);
          }
        } else if (showNotification) {
          const originalText = loadPresetBtn.textContent;
          loadPresetBtn.textContent = 'Nincs ment√©s';
          setTimeout(() => {
            loadPresetBtn.textContent = originalText;
          }, 2000);
        }
      }

      function exportSettings() {
        const settings = {
            title: document.getElementById('title').value,
            tempo: document.getElementById('tempo').value,
            key: document.getElementById('key').value,
            lyrics: document.getElementById('lyricsText').value,
            vocal: document.querySelector('#vocalChips .chip.active').dataset.value,
            vocalTypes: Array.from(document.querySelectorAll('#vocalType .chip.active')).map(c => c.dataset.voctype),
            mood: document.getElementById('mood').value,
            theme: document.getElementById('theme').value,
            styles: Array.from(document.querySelectorAll('#styleChips .chip.active')).map(c => c.dataset.value),
            styleExtra: document.getElementById('styleExtra').value,
            negative: document.getElementById('negative').value,
            instruments: Array.from(document.querySelectorAll('#instChips .chip.active')).map(c => c.dataset.value),
            instExtra: document.getElementById('instExtra').value,
            structure: document.getElementById('structure').value,
            ending: document.getElementById('ending').value,
            mix: document.getElementById('mix').value,
            timeSignature: timeSignatureSelect.value,
        };
        const jsonString = JSON.stringify(settings, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'suno_prompt_settings.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function importSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const settings = JSON.parse(event.target.result);
                applyImportedSettings(settings);
                const originalText = importBtn.textContent;
                importBtn.textContent = 'Import√°lva!';
                setTimeout(() => {
                    importBtn.textContent = originalText;
                }, 2000);
              } catch (error) {
                alert('√ârv√©nytelen JSON f√°jl!');
                console.error(error);
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }
      
      function applyImportedSettings(settings) {
        resetForm();
        
        document.getElementById('title').value = settings.title || '';
        document.getElementById('tempo').value = settings.tempo || '100';
        document.getElementById('key').value = settings.key || '';
        document.getElementById('lyricsText').value = settings.lyrics || '';
        document.getElementById('mood').value = settings.mood || '';
        document.getElementById('theme').value = settings.theme || '';
        document.getElementById('styleExtra').value = settings.styleExtra || '';
        document.getElementById('negative').value = settings.negative || '';
        document.getElementById('structure').value = settings.structure || '';
        document.getElementById('ending').value = settings.ending || 'clear, resolved ending (no fade-out)';
        document.getElementById('mix').value = settings.mix || '';
        document.getElementById('instExtra').value = settings.instExtra || '';
        timeSignatureSelect.value = settings.timeSignature || '4/4';
        
        vocalChips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        const vocalChip = document.querySelector(`#vocalChips .chip[data-value="${settings.vocal}"]`);
        if (vocalChip) { vocalChip.classList.add('active'); }
        document.getElementById('lyricsText').disabled = (settings.vocal === 'instrumental');
        if (settings.vocal === 'vocal') { lyricsGenOpts.style.display = 'block'; } else { lyricsGenOpts.style.display = 'none'; }
        
        if (settings.vocalTypes) { settings.vocalTypes.forEach(type => { const chip = document.querySelector(`#vocalType .chip[data-voctype="${type}"]`); if (chip) chip.classList.add('active'); }); }
        if (settings.styles) { settings.styles.forEach(style => { const chip = document.querySelector(`#styleChips .chip[data-value="${style}"]`); if (chip) chip.classList.add('active'); }); }
        if (settings.instruments) { settings.instruments.forEach(inst => { const chip = document.querySelector(`#instChips .chip[data-value="${inst}"]`); if (chip) chip.classList.add('active'); }); }
        
        // Do not generate prompt on load to avoid unnecessary API calls
      }

      function updateSuggestedTimeSignature(clickedChip) {
        if (clickedChip && clickedChip.classList.contains('active')) {
            const style = clickedChip.dataset.value;
            const signature = STYLE_TIME_SIGNATURES[style];
            if (signature) {
                timeSignatureSelect.value = signature;
            }
        } else {
            const activeStyles = Array.from(styleChipsContainer.querySelectorAll('.chip.active'));
            if (activeStyles.length > 0) {
                const lastStyle = activeStyles[activeStyles.length - 1].dataset.value;
                const signature = STYLE_TIME_SIGNATURES[lastStyle];
                if (signature) {
                    timeSignatureSelect.value = signature;
                }
            } else {
                timeSignatureSelect.value = '4/4';
            }
        }
      }

      // Kezdeti √°llapot be√°ll√≠t√°sa
      loadSavedSettings(); // Load saved settings on start, including API key
    });
  </script>
</body>
</html>
